#!/bin/bash

BOOK_PATH="/home/jovyan/content"
BOOK_CONFIG="${BOOK_PATH}/_config.yml"
if test -f $BOOK_CONFIG; then
    echo "This repository contains a Jupyter Book configuration."
    REF=$(git rev-parse HEAD)
    BOOK_INPUT="/home/jovyan/book-artifacts/$REF"

    if [ -d "${BOOK_INPUT}" ]; then
        echo "Loading previous Jupyter Book from commit $REF."
    else
        echo "Building Jupyter Book from commit $REF."
        jupyter-book build ${BOOK_PATH}
        mkdir ${BOOK_INPUT}
        mv ${BOOK_PATH}/_build/* ${BOOK_INPUT}
        rm -r ${BOOK_PATH}/_build
    fi
    ln -s ${BOOK_INPUT} /home/jovyan/content/_build
fi

exec "$@"
